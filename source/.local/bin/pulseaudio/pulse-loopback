#!/usr/bin/env sh
# ---------------------------------------------------------------------------------------------------------------------
# PULSE LOOPBACK
#
# Synopsis: pulse-loopback [ on | off ]
#
# Controls the PulseAudio loopback module, if you're like me and like hearing your voice and keyboard clack when using
# headphones.
# Calling with no argument toggles, otherwise enables or disables.
# Always selects the current default sink as an output, which cannot be moved!
# This is to prevent unwanted feedback loops when switching to speakers.
# ---------------------------------------------------------------------------------------------------------------------

# Unique notification ID for this action.
NID='0x800100'

# No argument specified, figure out which one it should be for toggle effect.
if [ -z "$1" ]; then
  if pactl list | grep 'Name: module-loopback'; then
    1='off'
  else
    1='on'
  fi
fi

# Load or unload the module.
case "$1" in
'on')
  pactl load-module module-loopback latency_msec=1 max_latency_msec=10 \
    sink_dont_move=true sink=@DEFAULT_SINK@ &&
    dunstify -r "$NID" -u low '🎙️ Loopback Enabled.'
  ;;
'off')
  pactl unload-module module-loopback
  dunstify -r "$NID" -u low '🎙️ Loopback Disabled.'
  ;;
*)
  echo >&2 "Must be called with one of the options: on | off"
  exit 1
  ;;
esac
